//
// Copyright (c) Open Source Buddhism Library 2020 www.buddism.ru
// ****************************************************************************
//  NAMO TASSA BHAGAVATO ARAHATO SAMMA SAMBUDDHASSA
//  May Buddha Dharma bring benefit and peace in all the world.
// ****************************************************************************
//
//C- This software is subject to, and may be distributed under, the
//C- GNU General Public License, either Version 2 of the license,
//C- or (at your option) any later version. The license should have
//C- accompanied the software or you may obtain a copy of the license
//C- from the Free Software Foundation at http://www.fsf.org.

#include "GGraph.h"

namespace ocr
{
/** @bref  Функция поиска и сравнения групп DStar 
	Результатом работы функции является массив гипотез наличия
	в тексте групп звездочек базы дазы данных эталонов букв и слогов и их корреляции. Основная функция распознавания гипотез слогов.
	*/
void GGraph::DStarRecognition()
{
	/**
	
		Сравнение групп DStar практический аспект
		
		23 Июля 2019 год
		Применение DStar для распознавания слогов и стеков.
		Распознавание групп DStar выполняется поэтапным применением алгоритмов сужения области поиска и уточнения корреляции групп DStar. 
		
		На первом этапе поиска и сравнения основной задачей является нахождение области наиболее вероятного соответствия группы DStar эталона и текста.
		На втором этапе вычисляется масштаб группы DStar текста по отношению к эталону.
		На третьем этапе вычисляется корреляция соответствия группы DStar эталона и текста.
		
		ПЕРВЫЙ ЭТАП
		Находим плотности DStar соответствующих эталонному слогу базы данных, то есть облако гипотез DStar.
		Этот этап позволяет исключить из обработки большое количество не нужных гипотез соответствия слогов базы данных эталонов и текста. 
		Для поиска создаем два массива.
		Первый массив это линейный битовый массив-регистр длиной в сумму длин всех строк.
		В таком массиве значением бита отмечается факт наличия хеша DStar из набора хешей DStar эталонного слога.
		Положение бита в массиве-регистре это координаты центра DStar по оси Х.
		Для создания такого массива проецируем на ось "X" каждой строки текста центры DStar совпадающие с эталоном по значению хеша.
		Если два DStar претендуют на один бит то значением бита отмечается только факт наличия совпадения 0-1. 
		Для получения координат Х каждого DStar текста по значению хеша DStar эталона создается двухмерный массив где по значению хеша расположен массив координат Х DStar текста.
		Битовый поисковый массив-регистр заполняется для поиска гипотез каждого эталонного слога в тексте  - около 40 000 раз на страницу. 
		Поиск облака гипотез DStar эталонного слога в массиве-регистре выполняется командой popcnt которая выполняет подсчет единиц в регистре.
		Миллиард 128 разрядных регистров popcnt подсчитывается за 0,7 секунд.
		Ширина окна в котором подсчитывается количество совпавших бит расчитывается на основании гипотезы масштаба эталонного слога в тексте относительно средней высоты строки текста.
		
		Второй массив необходим для получения значения хеша каждого DStar текста по значению координаты Х и номеру строки.
		Создаем двухмерный массив ushort длиной в сумму длин всех строк.
		В этот двухмерный массив по значению индекса соответствующего координате по X в одномерный массив записываются значения хеша DStar текста.
		Этот двухмерный массив создается один раз на страницу.
		
		Затем проверяем наличие в облаке гипотез значений всех хешей эталона.  
		Второй этап выполняется для облаков гипотез выявленных на первом этапе.
		
		
		ВТОРОЙ ЭТАП
		Вычисление относительного масштаба группы DStar эталона и DStar облака гипотез DStar текста.
		Сравнение эталона и облака начинаем с наиболее устойчивого и характерного DStar эталона. Проверяем наличие такого хеша DStar в облаке. Для каждого DStar текста совпадающего с эталонным диполем по значению хеша выполняем проверку корреляции DStar выполнением первого, второго и третьего lookup корреляции двух  DStar.
		Если значение корреляции двух DStar выше порога то принимаем центр этого DStar текста как центр гипотезы эталонного слога в тексте.
		В соответствии с масштабом соотношения эталонного и тестового DStar производим сравнение других DStar эталона, последовательно уточняя масштаб.
		В том случае если первый DStar эталона не выявил корреляции первых трех DStar слога, выполняем поиск корреляции DStar эталона и текста начиная со второго устойчивого и характерного DStar эталона.
		
		
		ТРЕТИЙ ЭТАП
		На основании гипотезы масштаба вычисленной в предыдущих lookup 
		выполняем проверку корреляции DStar эталона и текста по четвертому и пятому lookup сравнения DStar (масштабозависимое сравнение формы фокальных линий DStar и формы штрихов из которых образованы фокальные линии)
	
	
	
	*/

} //________________________________________________________________

} //namespace ocr
