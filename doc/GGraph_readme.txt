//@___________GGraphDStarCorrelation.cpp

//  OCRLib  2015 http://www.buddism.ru.
//****************************************************************************
//  NAMO TASSA BHAGAVATO ARAHATO SAMMA SAMBUDDHASSA
//  May Buddha Dharma bring benefit and peace in all the world.
//****************************************************************************
//
//C- This software is subject to, and may be distributed under, the
//C- GNU General Public License, either Version 2 of the license,
//C- or (at your option) any later version. The license should have
//C- accompanied the software or you may obtain a copy of the license
//C- from the Free Software Foundation at http://www.fsf.org.

//*******************************************************************************

#include "GGraph.h"

/*
 
 https://www.buddism.ru:4443/?index=4670&&field=1ln=rus&ocrData=TibetanUTFToRus&mode=read&ln=rus
 ཡིད་གུས་པས་དད་མོས་རྩེ་གཅིག་གི་ངང་འདི་ནས་བཟུང་བྱང་ཆུབ་མ་ཐོབ་ཀྱི་བར་བློ་གཏད་ལིང་བསྐྱུར་ཅི་མཛད་ཁྱེད་ཤེས་ཀྱིས་སྐྱབས་སུ་འགྲོ་བར་མོས་ལ་སྐྱབས་འགྲོ་ལན་གསུམ་སོགས་བཏོན་ཞིང་དགེ་བའི་སྨོན་ལམ་དང༌།
 --------------------------------------------------------------------------------------------------------------------------------
 
 ПОИСК ЭТАЛОНА В ТЕКСТЕ НА ОСНОВЕ DStar (двойных звезд). 3 сентября 2019
 
 DStar это две OCRStar соединенные фокальной линией и от одной до трех звездочек соединенных с каждой из базовой звездочек
    

При распознавании рукописного текста и при точном распознавани печатного текста есть две основные задачи:
 
 
ПЕРВАЯ
При распознавании сходных по начертанию букв небходимо точно учесть графическую разность определяющую различие этих букв. Также необходимо допустить вариабельность сходных частей таких букв.
В рукописном тексте базовые буквы имеют высокую вариабельность. Такие буквы не достаточно точно распознаются сравнением с одним или несколькими эталонами.
Некоторые буквы отличаются незначительными по площади элементами, различия которых могут быть меньше общей вариабельности начертания буквы.  
 
 
ВТОРАЯ
Необходимо выделить из текста новые эталоны букв и внести их в базу данных распознавания.


РЕШЕНИЕ ПЕРВОЙ ЗАДАЧИ
Все базовые буквы в базе данных необходимо представить как совокупности графических элементов, повторяющихся в начертании различных букв и модификаторов. 
Повторяющиеся графические элементы букв отлияающиеся между собой по начертанию и общие для подмножества букв алфавита назовем протобуквами. Модификаторами назовем графические элементы букв определяющие графическое различие букв.
Это позволит увеличить вариабельнсть начертаний базовых букв за счет комбинатоики протобукв и модификаторов в различных начертаниях буквы.
Также разбиение буквы на повторяющиеся и различающиеся элементы (протобуквы имодификаторы) позволит точно учесть значимые графические различия. 
Ведение алфавита протобукв позволит на первом этапе распознавания разметить текст гипотезами 
протобукв и модификаторов и собирать гипотезы букв из протобукв за счет комбинаторики элементов. 
Такая унификация графических признаков букв позволит сократить вычислительные затраты на 
формирования гипотез букв за счет сокращения количества графических сравнений с эталонами.

Классификация протобукв и модификаторов.
Для выделения протобукв в базе данных группируем буквы сходные по начертанию и имеющие различное значение Юникода.
Для каждой пары этих букв определям графическиую разность и общую часть.
Сравнением общих частей разных пар букв находим наименьшую общую часть.
Такая общая часть может состоять из одного или группы DStar.
Также находим наименьшие графические разности букв - модификаторы.
Такие протобуквы и модификаторы заносим в базу данных и используем для распознавания
сходных по начертанию букв вместо основных эталонов из которых он  получены. 
При этом в эталоне буквы указываем из каких протобукв и модификаторов состоит эталон
и на каких геометрических позициях должны находится все элементы.
Такой подход математически эквивалентен подсчету корреляции групп DStar и принятия решения о их
взаимной корреляции в двух-уровневой сверточной нейросети.
Распознавание такой буквы составленной из протобукв и модификаторов произходит в таком порядке:
1. Протобуквы распознаются в тексте как обычные буквы.
2. После формирования гипотезы масштаба и положения протобуквы распознавание модификаторов
на основе найденного масштаба и геометрического положения.
Корреляция модификаторов суммируется с корреляцией протобуквы пропорционально площади.
Поскольку общая часть сходных букв в таком случае имеет одинаковую корреляцию, различение таких сходных 
букв будет определятся графической разностью.


Проблемы сборки слогов. При построении пары букв необходимо учесть правила построения тибетского слога. при построении пары букв
неоходимо указывать вероятность пары и наличия разделителя слогов в паре. 


 РЕШЕНИЕ ВТОРОЙ ЗАДАЧИ
 Выделенные на первом этапе распознавания гипотезы стековых и одиночных букв заносим в промежуточную базу данных 
 и классифицируем на основе сравнения DStar каждой гипотезы со всей группой коррелируемых гипотез.
 Наиболее устойчивые гипотезы проверяем вручную и заносим в основную базу.
 
 
 СРАВНЕНИЕ И ВЫЧИСЛЕНИЕ КОРРЕЛЯЦИИ DStar
 
*/

/** @bref Функция вычисления корреляции двух DStar в соответствии с  заданным порядком сравнения
*/

void GGraph::DStarCorrelation(DStar &star, DStar &starTest, int mode)
{
	/**
		
		Вычисление корреляяции двух DStar (двойных звездочек) производится последовательным применением масштабо зависимых и масштабо не зависимых алгоритмов - lookup.
		Масштабо не зависимые алгоритмы позволяют произвести быструю
		оценку корреляции больших групп DStar.
		Однако эти алгоритмы не инвариантны к разрывам фокальных линий и наличию шумовых фокальных точек.
		Для вычисления корреляции гипотез соответствия групп DStar
		текста и базы данных эталонов выявленных масштабонезависимыми алгоритмами применяется вторая группа алгоритмов масштабозависимые lookup.
		Эти алгоритмы не инвариантны к масштабу и другим афинным преобразованиям текста. Также эти алгоритмы более медленные чем алгоритмы первой группы. Однако эти алгоритмы практически инвариантны к разрывам фокальных линий и наличию шумовых фокальных точек. Пятый lookup позволяет также анализировать форму штрихов буквы так же как и битовые признаки, но значительно быстрее.
		Таким образом первая группа алгоритмов позволяет быстро вычислить масштаб гипотез и распознавать чисто напечатанные тексты которые можно привести к виду шрифта Courier в котором все штрихи букв моноширинные.
		Также первая группа алгоритмов позволяет сократить комбинаторику при распознавании поврежденных и рукописных текстов.
		Вторая группа алгоритмов позволяет распознавать поврежденные и 
		рукописные тексты.
	
		
		
		МАСШТАБО НЕЗАВИСИМЫЕ lookup
			Первый lookup сравнение хешей DStar
			Значения хеша вычисляется в функции @fn GGraph::buildAllDStarHash
			
			Второй lookup
			Для двух OCRStar входящих в DStar выполняем проверку корреляции концов лучей @fn OCRStarCorrelation второй lookup
			
			Третий lookup
			Для двух OCRStar входящих в DStar выполняем проверку корреляции точек экстремума  @fn OCRStarCorrelation третий lookup
			
			Для DStar содержащих круг или части дуг как основную фокальную линию применяем метод корреляции кругов описаный в функции @fn GGraph::DStarArcCorrelation.
			
		МАСШТАБО ЗАВИСИМЫЕ lookup
		
			ЧЕТВЕРТЫЙ lookup кореляции DStar.
			Сравнение DStar эталона и текста по лимитам координат концов лучей звездочек и их точек экстремума.
		
			
			ПЯТЫЙ lookup кореляции DStar.
			Сравнение формы штриха исходного изображения соответствущего основной фокальной линии DStar.
		 
		*/

} //________________________________________________________________
